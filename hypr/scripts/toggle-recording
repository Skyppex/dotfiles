#!/usr/bin/env nu

const pid_file = "/tmp/hypr/wf-recording.pid"
const out = "/tmp/hypr/recording.mp4"

def is-alive []: nothing -> bool {
    print -e "1.1"
    if not ($pid_file | path exists) {
        print -e "1.2"
        return false
    }

    print -e "1.3"
    let pid = (open -r $pid_file | str trim | into int)

    print -e "1.4"
    if (ps | where pid == $pid | is-empty) {
        print -e "1.5"
        return false
    }

    print -e "1.6"
    return true
}

mkdir "/tmp/hypr"

print -e "1"
if (is-alive) {
    print -e "2"
    let pid = (open -r $pid_file | str trim | into int)
    print -e "2.1"
    kill --signal 2 $pid
    print -e "2.2"
    rm $pid_file
    print -e "2.3"
    $"file://($out)(char --unicode d)(char --unicode a)" | wl-copy --type text/uri-list
    print -e "2.4"
    notify-send "recording stopped"
} else {
    print -e "3"
    let region = slurp

    print -e "4"

    if ($out | path exists) {
        print -e "4.1"
        rm $out
    }

    print -e $region
    let command = $"wf-recorder --audio-backend=pipewire --geometry '($region)' --audio --file ($out) >/dev/null 2>&1 & echo $!"
    print -e $command
    let last_pid = (^bash -c $command | into int)

    $last_pid | save --force $pid_file
    print -e $last_pid
    notify-send "recording started"
}
