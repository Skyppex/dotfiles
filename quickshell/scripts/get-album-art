#!/usr/bin/env python3

import os
import subprocess
import urllib.request

DOWNLOAD_PATH = "/tmp/quickshell/album-art.jpg"

CACHE_PATHS = [
    "/tmp/quickshell/album-art-a.jpg",
    "/tmp/quickshell/album-art-b.jpg",
]

DIM_FACTOR = "0.6"

last_index = -1


def download_and_print(url):
    os.makedirs("/tmp/quickshell", exist_ok=True)
    global last_index
    last_index = (last_index + 1) % 2
    cache_path = CACHE_PATHS[last_index]

    if url.startswith("http://") or url.startswith("https://"):
        try:
            urllib.request.urlretrieve(url, DOWNLOAD_PATH)
            dim_image(DOWNLOAD_PATH, cache_path)
            print(cache_path, flush=True)
        except Exception:
            print("", flush=True)
    elif url.startswith("file://"):
        path = url[len("file://") :]
        try:
            dim_image(path, cache_path)
            print(path, flush=True)
        except Exception:
            print("", flush=True)
    else:
        print("", flush=True)


def dim_image(in_path, out_path):
    subprocess.run(
        ["magick", in_path, "-evaluate", "Multiply", DIM_FACTOR, out_path],
        stdout=subprocess.PIPE,
        stderr=subprocess.PIPE,
        check=True,
    )


def main():
    process = subprocess.Popen(
        ["playerctl", "--follow", "metadata", "mpris:artUrl"],
        stdout=subprocess.PIPE,
        stderr=subprocess.DEVNULL,
        text=True,
        bufsize=1,
    )

    if process.stdout is None:
        return

    for line in process.stdout:
        url = line.strip()
        download_and_print(url)


if __name__ == "__main__":
    main()
